<h1>Moodle Book Chapter Search</h1>

<p>This script pulls from the listed Moodle books and returns chapters that match your search query.</p>

<p>Moodle has same origin policy set so ajax calls etc from outside the domain will fail. This script only works from inside Moodle.</p>

<div id="mbcs_db_wrapper">
    <p> Book database: </p>
    <table id="mbcs_db" style="border: 1px dashed lightgray; padding: 20px">
        <tbody><tr><td></td></tr>
    </tbody></table>
</div>

<p><br></p>

<div id="mbcs_input_wrapper">
    <input id="mbcs_input_query_text" placeholder="Query" type="text">
    <button id="mbcs_input_submit"> Submit </button>
    <span id="mbcs_error_text" style="font-size: small; color: red"></span>
</div>

<div id="mbcs_results_wrapper">
    <ul id="mbcs_results"><li></li></ul>
</div>

<script type="text/javascript">
//<![CDATA[
const mbcs_booksdb = [
    {
        title: "Topics: Resources, Learning and Assessment Activities",
        url: "https://moodle.op.ac.nz/mod/book/view.php?id=516081"
    },
    {
        title: "Topics: Copyright and Open Educational Resources",
        url: "https://moodle.op.ac.nz/mod/book/view.php?id=510030"
    },
    {
        title: "Topics: Orientation and Assisting Students",
        url: "https://moodle.op.ac.nz/mod/book/view.php?id=509523"
    }
];
// HTML Elements
let mbcs_db_html;
let mbcs_input_query_html;
let mbcs_input_submit_html;
let mbcs_error_html;
let mbcs_results_html;

let userQuery;

function mbcs_init() {
    // Get HTML elements
    mbcs_db_html = document.querySelector("table#mbcs_db");
    mbcs_input_query_html = document.querySelector("input#mbcs_input_query_text");
    mbcs_input_submit_html = document.querySelector("button#mbcs_input_submit");
    mbcs_error_html = document.querySelector("span#mbcs_error_text");
    mbcs_results_html = document.querySelector("ul#mbcs_results");
    // Populate table with booksdb
    for (const book of mbcs_booksdb) {
        const new_row = document.createElement("tr");
        new_row.innerHTML = "<td>" + "<a href='" + book.url + "'>" + book.title + "</a></td>";
        mbcs_db_html.appendChild(new_row);
    }
    // Listen to submit button
    mbcs_input_submit_html.addEventListener("click", mbcs_search);
}

async function mbcs_search() {

    // Clear results list
    mbcs_results_html.innerHTML = "";
    // Get search string
    userQuery = mbcs_input_query_html.value;

    if (userQuery.length <= 0) { 
        mbcs_error_html.innerHTML = "Required.";
        return;
    }

    for (const book_entry of mbcs_booksdb) {

        // Fetch book page
        try {
            var resp = await fetch(book_entry.url, {
                method: "GET",
                mode: "same-origin",
                credentials: "same-origin",
                redirect: "follow",
                headers: {
                    "Content-Type": "text/html"
                }
            });
            if(resp.ok) {
                var text = await resp.text();
                mbcs_parse_push_data(text, book_entry.title);
            } else {
                console.error("Error while fetching: " + resp.statusText);
                mbcs_error_html.innerHTML = "An error occured while fetching: " + book_entry.title;
            }

        } catch(err) {
            console.error("Error while fetching: " + err);
            mbcs_error_html.innerHTML = "An error occured while fetching: " + book_entry.title;
        }
    }
}

function mbcs_parse_push_data(data, title) {

    // Create HTML parser
    const parser = new DOMParser();
    // Parse book page
    const book_page = parser.parseFromString(data, "text/html");
    // Fetch table of contents
    const toc = book_page.querySelector(".book_toc_indented, .book_toc_none");
    // Create results line
    const results_title = document.createElement("p");
    results_title.innerHTML = "Results for " + title;
    const results_list = document.createElement("ul");

    // Operate on direct <a> children of <li> (no actionbar items)
    for (const node of Object.values(toc.querySelectorAll(":scope li > a"))) {
        if ((node.textContent || "").includes(userQuery)) {
            const title = node.getAttribute("title");
            const href = "https://moodle.op.ac.nz/mod/book/" + node.getAttribute("href");
            const listItem = document.createElement("li");
            listItem.innerHTML = "<a href='" + href + "'>" + title + "</a>";
            results_list.appendChild(listItem);
        }
    }
    // Add results
    mbcs_results_html.appendChild(results_title);
    if (results_list.firstChild) {
        mbcs_results_html.appendChild(results_list);
    }
    else {
        const no_results_message = document.createElement("p");
        no_results_message.innerHTML = "No results found";
        mbcs_results_html.appendChild(no_results_message);
    }
}

window.addEventListener("load", mbcs_init);
//]]>
</script>